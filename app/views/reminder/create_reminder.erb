<%-# Fedena
#Copyright 2010 Foradian Technologies Private Limited
#
#This product includes software developed at
#Project Fedena - http://www.projectfedena.org/
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing,
#software distributed under the License is distributed on an
#"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#KIND, either express or implied.  See the License for the
#specific language governing permissions and limitations
#under the License. -%>

<script>
  function add_recipient(recipient) {
    var recipient_list = new Array();
    if($('recipients_employees').value != '')
      recipient_list = $('recipients_employees').value.split(',');
    else
      recipient_list = [];

    var recipient_exists = false;

    for(i=0; i<recipient_list.length; i++)
      if(recipient_list[i] == recipient)
        recipient_exists = true;

    if(!recipient_exists) {
      recipient_list.push(recipient);
    }
    $('recipients_employees').value = recipient_list.join();
    recipients = $('recipients_employees').value;

<%= remote_function(:url => {:action => 'update_recipient_list'}, :with => "'recipients_employees='+recipients" ) %>
  }
  function add_recipient1(recipient) {
    var recipient_list = new Array();
    if($('recipients_students').value != '')
      recipient_list = $('recipients_students').value.split(',');
    else
      recipient_list = [];

    var recipient_exists = false;

    for(i=0; i<recipient_list.length; i++)
      if(recipient_list[i] == recipient)
        recipient_exists = true;

    if(!recipient_exists) {
      recipient_list.push(recipient);
    }
    $('recipients_students').value = recipient_list.join();
    recipients = $('recipients_students').value;
<%= remote_function(:url => {:action => 'update_recipient_list1'}, :with => "'recipients_students='+recipients" ) %>
  }
  function add_recipient2(recipient) {
    var recipient_list = new Array();
    if($('recipients_parents').value != '')
      recipient_list = $('recipients_parents').value.split(',');
    else
      recipient_list = [];

    var recipient_exists = false;

    for(i=0; i<recipient_list.length; i++)
      if(recipient_list[i] == recipient)
        recipient_exists = true;

    if(!recipient_exists) {
      recipient_list.push(recipient);
    }
    $('recipients_parents').value = recipient_list.join();
    recipients = $('recipients_parents').value;
<%= remote_function(:url => {:action => 'update_recipient_list2'}, :with => "'recipients_parents='+recipients" ) %>
  }

  function add_all_recipient(recipient) {
    var recipient_list = new Array();
    if($('recipients_employees').value != '')
      recipient_list = $('recipients_employees').value.split(',');
    else
      recipient_list = [];

    var new_list = recipient.split(',');

    for(i=0;i<new_list.length;i++)
    {
      var recipient_exists = false;
      for(j=0; j<recipient_list.length; j++)
        if(recipient_list[j] == new_list[i])
          recipient_exists = true;
      if(!recipient_exists) recipient_list.push(new_list[i]);
    }

    $('recipients_employees').value = recipient_list.join();
    recipients = $('recipients_employees').value;
<%= remote_function(:url => {:action => 'update_recipient_list'}, :with => "'recipients_employees='+recipients" ) %>
  }
  function add_all_recipient1(recipient) {
    var recipient_list = new Array();
    if($('recipients_students').value != '')
      recipient_list = $('recipients_students').value.split(',');
    else
      recipient_list = [];

    var new_list = recipient.split(',');

    for(i=0;i<new_list.length;i++)
    {
      var recipient_exists = false;
      for(j=0; j<recipient_list.length; j++)
        if(recipient_list[j] == new_list[i])
          recipient_exists = true;
      if(!recipient_exists) recipient_list.push(new_list[i]);
    }

    $('recipients_students').value = recipient_list.join();
    recipients = $('recipients_students').value;
<%= remote_function(:url => {:action => 'update_recipient_list1'}, :with => "'recipients_students='+recipients" ) %>
  }
  function add_all_recipient2(recipient) {
    var recipient_list = new Array();
    if($('recipients_parents').value != '')
      recipient_list = $('recipients_parents').value.split(',');
    else
      recipient_list = [];

    var new_list = recipient.split(',');

    for(i=0;i<new_list.length;i++)
    {
      var recipient_exists = false;
      for(j=0; j<recipient_list.length; j++)
        if(recipient_list[j] == new_list[i])
          recipient_exists = true;
      if(!recipient_exists) recipient_list.push(new_list[i]);
    }

    $('recipients_parents').value = recipient_list.join();
    recipients = $('recipients_parents').value;
<%= remote_function(:url => {:action => 'update_recipient_list2'}, :with => "'recipients_parents='+recipients" ) %>
  }


  function remove_recipient(recipient) {
    recipients = $('recipients_employees').value;
    var recipient_list = new Array();
    recipient_list = $('recipients_employees').value.split(',');

    for(i=0; i<recipient_list.length; i++)
      if (recipient_list[i] == recipient)
    {
      recipient_list.splice(i,1);
      break;
    }

    $('recipients_employees').value = recipient_list.join();
    recipients = $('recipients_employees').value;
<%= remote_function(:url => {:action => 'update_recipient_list'}, :with => "'recipients_employees='+recipients" ) %>



  }
  function remove_recipient2(recipient) {
    recipients = $('recipients_parents').value;
    var recipient_list = new Array();
    recipient_list = $('recipients_parents').value.split(',');

    for(i=0; i<recipient_list.length; i++)
      if (recipient_list[i] == recipient)
    {
      recipient_list.splice(i,1);
      break;
    }

    $('recipients_parents').value = recipient_list.join();
    recipients = $('recipients_parents').value;
<%= remote_function(:url => {:action => 'update_recipient_list2'}, :with => "'recipients_parents='+recipients" ) %>



  }
  function remove_recipient1(recipient) {
    recipients = $('recipients_students').value;
    var recipient_list = new Array();
    recipient_list = $('recipients_students').value.split(',');

    for(i=0; i<recipient_list.length; i++)
      if (recipient_list[i] == recipient)
    {
      recipient_list.splice(i,1);
      break;
    }

    $('recipients_students').value = recipient_list.join();
    recipients = $('recipients_students').value;
<%= remote_function(:url => {:action => 'update_recipient_list1'}, :with => "'recipients_students='+recipients" ) %>



  }
</script>

<div id="content-header">
  <%= show_header_icon %>
  <h1><%= t('messages') %></h1>
  <div class='header-sep'>|</div>
  <div class='sub-header'><%= t('create_text') %>/<%= t('new_text') %></div>

  <div id="inner-tab-menu">
    <ul>
      <% unless @new_reminder_count.size == 0 %>
        <li class='themed_bg themed-dark-hover-background'><%= link_to "<b>#{t('inbox')} (#{@new_reminder_count.size})</b>", :controller=>"reminder", :action=>"index"%></li>
      <% else %>
        <li class='themed_bg themed-dark-hover-background'><%= link_to "#{t('inbox')}", :controller=>"reminder", :action=>"index"%></li>
      <% end %>

      <li class='themed_bg themed-dark-hover-background'><%= link_to "#{t('sent')}", :controller=>"reminder", :action=>"sent_reminder" %></li>
      <li class='themed_bg themed-dark-hover-background'><%= link_to "#{t('create_text')}", :controller=>"reminder", :action=>"create_reminder" %></li>
    </ul>
  </div>

</div>
<div id="page-yield">
  <div class="bread_crumb">
    <%= make_breadcrumb %>
    <%= render_breadcrumbs  %>
  </div>
  <% unless flash[:notice].nil? %>
    <p class="flash-msg"> <%= flash[:notice] %> </p>
  <% end %>

  <div class="create-options">


    <% current_user = @current_user %>
  </div>
  <% form_for :reminder do |l| %>
    <div id="form">
      <%= error_messages_for :reminder %>
      <%unless @recipients_employees.blank?%>
        <%= hidden_field_tag :recipients_employees, @recipients_employees.collect(&:id).join(",")%>
      <%else%>
        <%= hidden_field_tag :recipients_employees,''%>
      <%end%>
      <%unless @recipients_students.blank?%>
        <%= hidden_field_tag :recipients_students, @recipients_students.collect(&:id).join(",")%>
      <%else%>
        <%= hidden_field_tag :recipients_students,''%>
      <%end%>
      <%unless @recipients_parents.blank?%>
        <%= hidden_field_tag :recipients_parents, @recipients_parents.collect(&:id).join(",")%>
      <%else%>
        <%= hidden_field_tag :recipients_parents,''%>
      <%end%>
      <%if @departments.present?%>
        <% @config = Configuration.available_modules  %>
        <% if @config.include?('HR') %>
          <div class="to-options">
            <div class="themed_text"><u>
                <%="#{t('reminder_to_staff')}"%>
              </u>
            </div>
          </div>
        <%end%>
        <%= image_tag("loader.gif",
          :align => "absmiddle",
          :border => 0,
          :id => "loader",
          :style =>"display: none;" ) %>
        <div class="extender"></div>
        <% if @config.include?('HR') %>
          <div id="select-employee-department">
      <%#     @user = current_user %>
      <%#if @user.admin? or @user.employee?%>
      <%#  @departments = EmployeeDepartment.find(:all, :conditions=>"status = true") %>
      <%#end%>
            <%if @departments.present?%>
              <%=   render :partial=>"select_employee_department" %>
            <%end%>
          </div>
        <% end %>

        <div class="label-field-to">
          <div id="to_employees">

          </div>
        </div>
      <%end%>
      <div class="extender"></div>

      <%if @batches.present?%>
        <div class="to-options">
          <div class="themed_text"><u>
              <%= "#{t('reminder_to_student')}" %>
            </u></div>
        </div>
        <%= image_tag("loader.gif",
          :align => "absmiddle",
          :border => 0,
          :id => "loader1",
          :style =>"display: none;" ) %>
        <div class="extender"></div>
        <div id="select-student-course">
    <%#     @user = current_user %>
    <%#if @user.admin? or @user.employee? or @user.student?%>
    <%#  @batches = Batch.active %>
    <%#else%>
    <%#@batches=[]%>
    <%#end%>
          <%if @batches.present?%>
            <%=  render :partial=> "select_student_course" %>
          <%end%>
        </div>
        <div class="label-field-to">
          <div id="to_students"></div>
        </div>
      <%end%>
      <div class="extender"></div>
      <%if @parents_for_batch.present?%>
        <div class="to-options">
          <div class="themed_text"><u>
              <%= "#{t('reminder_to_parent')}" %>
            </u></div>
        </div>
        <%= image_tag("loader.gif",
          :align => "absmiddle",
          :border => 0,
          :id => "loader2",
          :style =>"display: none;" ) %>
        <div class="extender"></div>
        <div id="select-parents">
    <%#     @user = current_user %>
    <%#if @user.admin? or @user.employee? or @user.student?%>
    <%#  @batches = Batch.active %>
    <%#else%>
    <%#@batches=[]%>
    <%#end%>
          <%if @parents_for_batch.present?%>
            <%=  render :partial=> "select_parents" %>
          <%end%>
        </div>
        <div class="label-field-to">
          <div id="to_parents"></div>
        </div>
      <%end%>
    </div>
    <div class="message">
      <div id="recipient-list"><%if @recipients_employees.present?%><%=render :partial=>'recipient_list_employees'%><%end%></div>
      <div id="recipient-list1"><%if @recipients_students.present?%><%=render :partial=>'recipient_list_students'%><%end%></div>
      <div id="recipient-list2"><%if @recipients_parents.present?%><%=render :partial=>'recipient_list_parents'%><%end%></div>
      <div class="label-field-pair">
        <label for="subject"><%= t('subject_messages') %></label>
        <%if @subject.present?%>
          <div class="text-input-bg"><%= l.text_field :subject,:value=>@subject %></div>
        <%else%>
          <div class="text-input-bg"><%= l.text_field :subject%></div>
        <%end%>
      </div>
      <div class="label-field-pair">
        <label for="student_grade"><%= t('message') %></label>
        <%if @body.present?%>
          <div class="text-area-bg"><%= l.text_area :body, :cols=>25, :rows=>10 ,:value=>@body%>
          <%else%>
            <div class="text-area-bg"><%= l.text_area :body, :cols=>25, :rows=>10 ,:value=>@body%>
          <%end%>
          </div>
        </div>
        <div class="extender"></div>
        <div id="submit-button">
          <%=submit_tag "#{t('send')}", :class => 'button', :disable_with => "#{t('please_wait')}" %>
        </div>
      </div>


      <% unless params[:send_to].nil? %>
        <script type="text/javascript">
          send_to = "<%=  params[:send_to] %>";
          recipient_list = send_to.split(',');
          for(i=0; i<recipient_list.length; i++)
            add_recipient(recipient_list[i]);
        </script>
      <% end %>
    <% end %>
    <div class="extender"></div>

  </div>
