<script type="text/javascript">
  function add_config_field(){
    div_count = j(".config-field-set").length
    op_box = j(".config-field-set:last").clone();
    op_box.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").attr("id","custom_gateway_gateway_parameters_config_fields_"+(div_count)+"_name");
    op_box.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").attr("name","custom_gateway[gateway_parameters][config_fields]["+(div_count)+"][name]");
    op_box.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").val("");

    op_box.find(".label-field-pair:last").find(".text-input-bg:first").find("input[type=text]:first").attr("id","custom_gateway_gateway_parameters_config_fields_"+(div_count)+"_value");
    op_box.find(".label-field-pair:last").find(".text-input-bg:first").find("input[type=text]:first").attr("name","custom_gateway[gateway_parameters][config_fields]["+(div_count)+"][value]");
    op_box.find(".label-field-pair:last").find(".text-input-bg:first").find("input[type=text]:first").val("");

    j("#con-fields").append(op_box);
  }

  function add_variable_field(){
    div_count = j(".variable-field-set").length
    op_box = j(".variable-field-set:last").clone();
    op_box.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").attr("id","custom_gateway_gateway_parameters_variable_fields_"+(div_count)+"_name");
    op_box.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").attr("name","custom_gateway[gateway_parameters][variable_fields]["+(div_count)+"][name]");
    op_box.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").val("");

    op_box.find(".label-field-pair:last").find(".text-input-bg:first").find("select:first").attr("id","custom_gateway_gateway_parameters_variable_fields_"+(div_count)+"_field_type");
    op_box.find(".label-field-pair:last").find(".text-input-bg:first").find("select:first").attr("name","custom_gateway[gateway_parameters][variable_fields]["+(div_count)+"][field_type]");
    op_box.find(".label-field-pair:last").find(".text-input-bg:first").find("select:first").prop('selectedIndex',0);

    j("#var-fields").append(op_box);
  }

  function add_response_field(){
    div_count = j(".response-field-set").length
    op_box = j(".response-field-set:last").clone();
    op_box.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").attr("id","custom_gateway_gateway_parameters_response_parameters_"+(div_count)+"_name");
    op_box.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").attr("name","custom_gateway[gateway_parameters][response_parameters]["+(div_count)+"][name]");
    op_box.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").val("");

    op_box.find(".label-field-pair:last").find(".text-input-bg:first").find("select:first").attr("id","custom_gateway_gateway_parameters_response_parameters_"+(div_count)+"_parameter_type");
    op_box.find(".label-field-pair:last").find(".text-input-bg:first").find("select:first").attr("name","custom_gateway[gateway_parameters][response_parameters]["+(div_count)+"][parameter_type]");
    op_box.find(".label-field-pair:last").find(".text-input-bg:first").find("select:first").prop('selectedIndex',0);

    j("#resp-fields").append(op_box);
  }

  function adjust_config_fields(th_is,div_count){
    d=j(th_is);

    d.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").attr("id","custom_gateway_gateway_parameters_config_fields_"+(div_count)+"_name");
    d.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").attr("name","custom_gateway[gateway_parameters][config_fields]["+(div_count)+"][name]");

    d.find(".label-field-pair:last").find(".text-input-bg:first").find("input[type=text]:first").attr("id","custom_gateway_gateway_parameters_config_fields_"+(div_count)+"_value");
    d.find(".label-field-pair:last").find(".text-input-bg:first").find("input[type=text]:first").attr("name","custom_gateway[gateway_parameters][config_fields]["+(div_count)+"][value]");

    return d;
  }

  function remove_config_field(th_is){
    div_count = j(".config-field-set").length
    if(div_count == 1){
      alert("Atleast 1 field is required.")
    }
    else{
      j(th_is).parent().remove();
      i=0
      j(".config-field-set").each(function(){
        adjust_config_fields(this,i);
        i=i+1
      });
    }
  }

  function adjust_variable_fields(th_is,div_count){
    d=j(th_is);

    d.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").attr("id","custom_gateway_gateway_parameters_variable_fields_"+(div_count)+"_name");
    d.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").attr("name","custom_gateway[gateway_parameters][variable_fields]["+(div_count)+"][name]");

    d.find(".label-field-pair:last").find(".text-input-bg:first").find("select:first").attr("id","custom_gateway_gateway_parameters_variable_fields_"+(div_count)+"_field_type");
    d.find(".label-field-pair:last").find(".text-input-bg:first").find("select:first").attr("name","custom_gateway[gateway_parameters][variable_fields]["+(div_count)+"][field_type]");

    return d;
  }

  function remove_variable_field(th_is){
    div_count = j(".variable-field-set").length
    if(div_count == 1){
      alert("Atleast 1 field is required.")
    }
    else{
      j(th_is).parent().remove();
      i=0
      j(".variable-field-set").each(function(){
        adjust_variable_fields(this,i);
        i=i+1
      });
    }
  }

  function adjust_response_fields(th_is,div_count){
    d=j(th_is);

    d.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").attr("id","custom_gateway_gateway_parameters_response_parameters_"+(div_count)+"_name");
    d.find(".label-field-pair:first").find(".text-input-bg:first").find("input[type=text]:first").attr("name","custom_gateway[gateway_parameters][response_parameters]["+(div_count)+"][name]");

    d.find(".label-field-pair:last").find(".text-input-bg:first").find("select:first").attr("id","custom_gateway_gateway_parameters_response_parameters_"+(div_count)+"_parameter_type");
    d.find(".label-field-pair:last").find(".text-input-bg:first").find("select:first").attr("name","custom_gateway[gateway_parameters][response_parameters]["+(div_count)+"][parameter_type]");

    return d;
  }

  function remove_response_field(th_is){
    div_count = j(".response-field-set").length
    if(div_count == 1){
      alert("Atleast 1 parameter is required.")
    }
    else{
      j(th_is).parent().remove();
      i=0
      j(".response-field-set").each(function(){
        adjust_response_fields(this,i);
        i=i+1
      });
    }
  }

</script>
<div id="content-header">
  <%= show_header_icon %>
  <h1><%= t('custom_gateways') %></h1>
  <div class='header-sep'>|</div>
  <div class='sub-header'><%= t('new_gateway') %></div>
</div>
<div id="page-yield">
  <div class="bread_crumb">
<%= make_breadcrumb %>
<%= render_breadcrumbs  %>
  </div>
  <% unless flash[:notice].nil? %><p class="flash-msg"><%= flash[:notice] %></p><% end %>

  <div class="box">
    <% form_for @gateway do|f| %>
      <%= f.error_messages %>
      <div class="label-field-pair">
        <label><%= t('name') %><span class="necessary-field">*</span></label>
        <div class="text-input-bg"><%= f.text_field :name %></div>
      </div>
      <% unless @gateway.gateway_parameters.nil? %>
        <div id="config-fields">
          <div class="config-header"><%= t('configuration_fields') %></div>
          <div id="con-fields">
            <% @gateway.gateway_parameters[:config_fields].each_pair do|k,v| %>
              <div class="config-field-set">
                <div class="label-field-pair">
                  <label><%= t('name') %></label>
                  <div class="text-input-bg"><%= text_field_tag "custom_gateway[gateway_parameters][config_fields][#{k}][name]", v["name"] %></div>
                </div>
                <div class="label-field-pair">
                  <label><%= t('value') %></label>
                  <div class="text-input-bg"><%= text_field_tag "custom_gateway[gateway_parameters][config_fields][#{k}][value]", v["value"] %></div>
                </div>
                <%= link_to "<div class='remove-bg'></div> #{t('remove')}","#",{:class=>"remove-config-link",:onClick=>"remove_config_field(this); return false;"} %>
              </div>
            <% end %>
          </div>
          <%= link_to "#{image_tag("/images/online_payments/add_3.png",:border => 0)} #{t('add_field')}","#", {:id=>"add_config_link",:onClick=>"add_config_field(); return false;"}  %>
        </div>
        <div id="variable-fields">
          <div class="config-header"><%= t('variable_fields') %></div>
          <div id="var-fields">
            <% @gateway.gateway_parameters[:variable_fields].each_pair do|k,v| %>
              <div class="variable-field-set">
                <div class="label-field-pair">
                  <label><%= t('name') %></label>
                  <div class="text-input-bg"><%= text_field_tag "custom_gateway[gateway_parameters][variable_fields][#{k}][name]", v["name"] %></div>
                </div>
                <div class="label-field-pair">
                  <label><%= t('field_type') %></label>
                  <div class="text-input-bg">
                    <%= select_tag "custom_gateway[gateway_parameters][variable_fields][#{k}][field_type]",options_for_select([["Amount","amount"],["Redirect URL","redirect_url"],["Item Name","item_name"],["Payer Firstname","firstname"],["Payer Lastname","lastname"],["Payer Email","email"],["Payer Phone","phone"]],v["field_type"]) %>
                  </div>
                </div>
                <%= link_to "<div class='remove-bg'></div> #{t('remove')}","#",{:class=>"remove-variable-link",:onClick=>"remove_variable_field(this); return false;"} %>
              </div>
            <% end %>
          </div>
          <%= link_to "#{image_tag("/images/online_payments/add_3.png",:border => 0)} #{t('add_field')}","#", {:id=>"add_variable_link",:onClick=>"add_variable_field(); return false;"}  %>
        </div>
        <div id="response-fields">
          <div class="config-header"><%= t('response_parameters') %></div>
          <div id="resp-fields">
            <% @gateway.gateway_parameters[:response_parameters].each_pair do|k,v| %>
              <div class="response-field-set">
                <div class="label-field-pair">
                  <label><%= t('name') %></label>
                  <div class="text-input-bg"><%= text_field_tag "custom_gateway[gateway_parameters][response_parameters][#{k}][name]", v["name"] %></div>
                </div>
                <div class="label-field-pair">
                  <label><%= t('parameter_type') %></label>
                  <div class="text-input-bg">
                    <%= select_tag "custom_gateway[gateway_parameters][response_parameters][#{k}][parameter_type]",options_for_select([["Amount","amount"],["Transaction Status","transaction_status"],["Success Code","success_code"],["Reason Code","reason_code"],["Online Transaction Reference","transaction_reference"]],v["parameter_type"]) %>
                  </div>
                </div>
                <%= link_to "<div class='remove-bg'></div> #{t('remove')}","#",{:class=>"remove-response-link",:onClick=>"remove_response_field(this); return false;"} %>
              </div>
            <% end %>
          </div>
          <%= link_to "#{image_tag("/images/online_payments/add_3.png",:border => 0)} #{t('add_field')}","#", {:id=>"add_response_link",:onClick=>"add_response_field(); return false;"}  %>
        </div>
      <% else %>
        <div id="config-fields">
          <div class="config-header"><%= t('configuration_fields') %></div>
          <div id="con-fields">
            <div class="config-field-set">
              <div class="label-field-pair">
                <label><%= t('name') %></label>
                <div class="text-input-bg"><%= text_field_tag "custom_gateway[gateway_parameters][config_fields][0][name]" %></div>
              </div>
              <div class="label-field-pair">
                <label><%= t('value') %></label>
                <div class="text-input-bg"><%= text_field_tag "custom_gateway[gateway_parameters][config_fields][0][value]" %></div>
              </div>
              <%= link_to "<div class='remove-bg'></div> #{t('remove')}","#",{:class=>"remove-config-link",:onClick=>"remove_config_field(this); return false;"} %>
            </div>
          </div>
          <%= link_to "#{image_tag("/images/online_payments/add_3.png",:border => 0)} #{t('add_field')}","#", {:id=>"add_config_link",:onClick=>"add_config_field(); return false;"}  %>
        </div>
        <div id="variable-fields">
          <div class="config-header"><%= t('variable_fields') %></div>
          <div id="var-fields">
            <div class="variable-field-set">
              <div class="label-field-pair">
                <label><%= t('name') %></label>
                <div class="text-input-bg"><%= text_field_tag "custom_gateway[gateway_parameters][variable_fields][0][name]" %></div>
              </div>
              <div class="label-field-pair">
                <label><%= t('field_type') %></label>
                <div class="text-input-bg">
                  <%= select_tag "custom_gateway[gateway_parameters][variable_fields][0][field_type]",options_for_select([["Amount","amount"],["Redirect URL","redirect_url"],["Item Name","item_name"],["Payer Firstname","firstname"],["Payer Lastname","lastname"],["Payer Email","email"],["Payer Phone","phone"]]) %>
                </div>
              </div>
              <%= link_to "<div class='remove-bg'></div> #{t('remove')}","#",{:class=>"remove-variable-link",:onClick=>"remove_variable_field(this); return false;"} %>
            </div>
          </div>
          <%= link_to "#{image_tag("/images/online_payments/add_3.png",:border => 0)} #{t('add_field')}","#", {:id=>"add_variable_link",:onClick=>"add_variable_field(); return false;"}  %>
        </div>
        <div id="response-fields">
          <div class="config-header"><%= t('response_parameters') %></div>
          <div id="resp-fields">
            <div class="response-field-set">
              <div class="label-field-pair">
                <label><%= t('name') %></label>
                <div class="text-input-bg"><%= text_field_tag "custom_gateway[gateway_parameters][response_parameters][0][name]" %></div>
              </div>
              <div class="label-field-pair">
                <label><%= t('parameter_type') %></label>
                <div class="text-input-bg">
                  <%= select_tag "custom_gateway[gateway_parameters][response_parameters][0][parameter_type]",options_for_select([["Amount","amount"],["Transaction Status","transaction_status"],["Success Code","success_code"],["Reason Code","reason_code"],["Online Transaction Reference","transaction_reference"]]) %>
                </div>
              </div>
              <%= link_to "<div class='remove-bg'></div> #{t('remove')}","#",{:class=>"remove-response-link",:onClick=>"remove_response_field(this); return false;"} %>
            </div>
          </div>
          <%= link_to "#{image_tag("/images/online_payments/add_3.png",:border => 0)} #{t('add_field')}","#", {:id=>"add_response_link",:onClick=>"add_response_field(); return false;"}  %>
        </div>
      <% end %>
      <div id="submit-button">
        <%=f.submit("► #{t('create_text')}", :disable_with => "► #{t('please_wait')}" )%>
      </div>
    <% end %>
  </div>
</div>